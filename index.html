<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ğŸ² Dice Mastery</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;600;700&family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
<!-- Firebase -->
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0f1f17;--surface:#1a3328;--gold:#f5c842;--ink:#1a1a1a;
  --s1:#2980b9;--s1bg:#dbeeff;--s2:#27ae60;--s2bg:#d5f5e3;
  --s3:#c9980a;--s3bg:#fef9e7;--s4:#e67e22;--s4bg:#fdebd0;
  --s5:#e74c3c;--s5bg:#fadbd8;--steal:#8b5cf6;
}
html,body{height:100%;overflow:hidden;font-family:'DM Sans',sans-serif;background:var(--bg);color:#f0ebe0;touch-action:manipulation}
.screen{display:none;position:fixed;inset:0;overflow-y:auto}
.screen.active{display:flex;flex-direction:column}

/* â”€â”€ INSTRUCTIONS â”€â”€ */
#instructions{align-items:center;justify-content:center;background:var(--bg)}
.instr-wrap{width:100%;max-width:520px;height:100%;display:flex;flex-direction:column}
.instr-dots{display:flex;gap:6px;justify-content:center;padding:16px 0 8px;flex-shrink:0}
.instr-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);transition:all .25s}
.instr-dot.on{background:var(--gold);transform:scale(1.3)}
.instr-slide{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 24px;text-align:center;gap:14px;animation:fadeSlide .25s ease-out}
@keyframes fadeSlide{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.instr-icon{font-size:clamp(3rem,10vw,5rem);line-height:1}
.instr-en{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.5rem,5vw,2.4rem);letter-spacing:.08em;color:var(--gold);line-height:1.1}
.instr-body-en{font-size:clamp(.85rem,2.5vw,1.1rem);color:rgba(240,235,224,.8);line-height:1.65;max-width:400px}
.instr-divider{width:40px;height:2px;background:rgba(245,200,66,.3);border-radius:2px}
.instr-jp{font-family:'Noto Sans JP','Hiragino Sans','YuGothic','Meiryo',sans-serif;font-size:clamp(1rem,3.5vw,1.5rem);color:rgba(240,235,224,.7);line-height:1.3}
.instr-body-jp{font-family:'Noto Sans JP','Hiragino Sans','YuGothic','Meiryo',sans-serif;font-size:clamp(.75rem,2.2vw,.95rem);color:rgba(240,235,224,.5);line-height:1.8;max-width:400px}
.instr-slots{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:380px}
.instr-slot-chip{border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:8px;text-align:left}
.instr-slot-chip .sc-icon{font-size:1.3rem;flex-shrink:0}
.instr-slot-chip .sc-text{display:flex;flex-direction:column;gap:1px}
.instr-slot-chip .sc-en{font-size:.72rem;font-weight:700;letter-spacing:.06em}
.instr-slot-chip .sc-jp{font-family:'Noto Sans JP','Hiragino Sans','YuGothic','Meiryo',sans-serif;font-size:.62rem;opacity:.6}
.instr-nav{display:flex;align-items:center;justify-content:space-between;padding:12px 20px 20px;flex-shrink:0;gap:10px}
.instr-prev{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:12px 20px;color:rgba(240,235,224,.5);font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer}
.instr-prev:disabled{opacity:.2;cursor:default}
.instr-next{flex:1;background:var(--gold);border:none;border-radius:10px;padding:13px 20px;color:var(--ink);font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer}
.instr-skip{background:none;border:none;color:rgba(240,235,224,.25);font-size:.7rem;font-family:'DM Sans',sans-serif;cursor:pointer;letter-spacing:.1em;text-transform:uppercase;padding:4px 8px;white-space:nowrap}

/* â”€â”€ HOME â”€â”€ */
#home{align-items:center;justify-content:center;gap:20px;padding:30px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.5rem,8vw,4rem);letter-spacing:.14em;color:var(--gold);text-shadow:0 0 40px rgba(245,200,66,.4);text-align:center;line-height:1}
.logo-sub{font-size:.7rem;font-family:'DM Sans',sans-serif;letter-spacing:.25em;text-transform:uppercase;color:rgba(240,235,224,.3);text-align:center}
.home-btns{display:flex;flex-direction:column;gap:12px;width:100%;max-width:360px}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px 20px;border-radius:14px;border:none;font-family:'DM Sans',sans-serif;font-weight:700;font-size:1.05rem;cursor:pointer;width:100%}
.btn-gold{background:var(--gold);color:var(--ink)}
.btn-surface{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);color:#f0ebe0}
.btn-ghost{background:none;border:1px solid rgba(255,255,255,.15);color:rgba(240,235,224,.5);font-size:.85rem}
.home-or{text-align:center;font-size:.7rem;color:rgba(240,235,224,.25);letter-spacing:.15em;text-transform:uppercase}

/* â”€â”€ JOIN â”€â”€ */
#join{align-items:center;justify-content:center;gap:18px;padding:24px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))}
.join-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.1em;color:var(--gold);text-align:center}
.join-sub{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:.85rem;color:rgba(240,235,224,.5);text-align:center}
.code-input{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.15);border-radius:14px;padding:16px 20px;color:#f0ebe0;font-size:2rem;font-family:'Bebas Neue',sans-serif;letter-spacing:.3em;text-align:center;width:100%;max-width:260px;outline:none}
.code-input:focus{border-color:var(--gold)}
.animal-pick{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:360px}
.animal-btn{aspect-ratio:1;border-radius:14px;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);font-size:2.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;position:relative}
.animal-btn.selected{border-color:var(--gold);background:rgba(245,200,66,.15);transform:scale(1.08)}
.animal-btn.taken{opacity:.3;cursor:not-allowed}
.animal-btn.taken::after{content:'âœ•';position:absolute;font-size:1rem;color:#e74c3c}
.join-err{color:#e74c3c;font-size:.8rem;font-family:'Noto Sans JP','DM Sans',sans-serif;text-align:center;min-height:20px}

/* â”€â”€ LOBBY â”€â”€ */
#lobby{align-items:center;justify-content:center;gap:16px;padding:24px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))}
.lobby-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:.1em;color:var(--gold);text-align:center}
.room-code-display{background:rgba(245,200,66,.1);border:2px solid rgba(245,200,66,.3);border-radius:14px;padding:14px 30px;text-align:center}
.room-code-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.2em;color:rgba(240,235,224,.4);font-family:'DM Sans',sans-serif}
.room-code-num{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;letter-spacing:.3em;color:var(--gold);line-height:1}
.lobby-animals{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:400px}
.lobby-animal{display:flex;flex-direction:column;align-items:center;gap:4px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 14px;min-width:70px;transition:all .3s}
.lobby-animal.joined{border-color:var(--gold);background:rgba(245,200,66,.1);animation:popIn .3s ease-out}
@keyframes popIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.lobby-animal-icon{font-size:2rem}
.lobby-animal-label{font-size:.6rem;color:rgba(240,235,224,.4);font-family:'DM Sans',sans-serif;text-transform:uppercase;letter-spacing:.1em}
.lobby-waiting{font-size:.8rem;color:rgba(240,235,224,.4);font-family:'Noto Sans JP','DM Sans',sans-serif;text-align:center}
.lobby-you{font-size:.65rem;color:var(--gold);font-family:'DM Sans',sans-serif;font-weight:700}

/* â”€â”€ CONNECTION STATUS â”€â”€ */
.conn-bar{display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;background:rgba(0,0,0,.3);font-size:.65rem;font-family:'DM Sans',sans-serif;flex-shrink:0}
.conn-dot{width:6px;height:6px;border-radius:50%;background:#e74c3c;flex-shrink:0}
.conn-dot.ok{background:#27ae60}
.conn-dot.pulse{animation:connPulse 1s infinite}
@keyframes connPulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ SETUP (teacher) â”€â”€ */
#setup{align-items:center;justify-content:center;gap:16px;padding:20px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))}
.setup-box{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:20px;width:100%;max-width:480px;display:flex;flex-direction:column;gap:12px}
.setup-box h2{font-size:1rem;color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:.1em}
.points-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
.points-row label{font-size:.75rem;color:rgba(240,235,224,.5)}
.points-select{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#f0ebe0;padding:6px 12px;font-size:.9rem;font-family:'DM Sans',sans-serif}

/* â”€â”€ SCORE BAR â”€â”€ */
.score-bar{display:flex;gap:6px;padding:8px 10px;background:rgba(0,0,0,.4);border-bottom:1px solid rgba(255,255,255,.07);overflow-x:auto;flex-shrink:0;z-index:10}
.sc{display:flex;flex-direction:column;align-items:center;padding:5px 10px;border-radius:8px;border:2px solid transparent;flex-shrink:0;min-width:60px;transition:border-color .2s,background .2s}
.sc.active{border-color:var(--gold);background:rgba(245,200,66,.1)}
.sc.me{border-color:rgba(255,255,255,.3)}
.sc .sa{font-size:1.3rem;line-height:1}
.sc .sn{font-size:.58rem;font-weight:700;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:rgba(240,235,224,.7)}
.sc .sp{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--gold);line-height:1}

/* â”€â”€ SLIDE AREA â”€â”€ */
#game{background:var(--bg)}
.slide-area{flex:1;display:flex;align-items:center;justify-content:center;padding:12px;overflow:hidden}

/* â”€â”€ ROLL CARD â”€â”€ */
.roll-card{background:var(--surface);border:3px solid rgba(245,200,66,.25);border-radius:20px;padding:clamp(20px,4vw,40px);display:flex;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:480px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.turn-label{font-size:.7rem;font-family:'DM Sans',sans-serif;text-transform:uppercase;letter-spacing:.2em;color:rgba(240,235,224,.35)}
.turn-animal{font-size:clamp(3rem,10vw,5rem);line-height:1}
.turn-name{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.8rem,6vw,3rem);letter-spacing:.1em;color:var(--gold)}
.die-btn{width:clamp(80px,18vw,110px);height:clamp(80px,18vw,110px);background:#faf7f0;border-radius:18px;border:none;font-size:clamp(2.5rem,8vw,4rem);cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.4),inset 0 2px 0 rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;transition:transform .1s;flex-shrink:0}
.die-btn:active{transform:scale(.9)}
.die-btn.rolling{animation:spin .45s ease-out}
.die-btn.disabled-die{opacity:.4;cursor:not-allowed;pointer-events:none}
@keyframes spin{0%{transform:rotate(0)scale(1)}40%{transform:rotate(200deg)scale(1.2)}70%{transform:rotate(380deg)scale(.9)}100%{transform:rotate(360deg)scale(1)}}
.roll-instruction{font-size:.8rem;color:rgba(240,235,224,.4)}
.watching-label{font-size:.85rem;color:rgba(240,235,224,.35);font-family:'Noto Sans JP','DM Sans',sans-serif;font-style:italic}

/* â”€â”€ QUESTION CARD â”€â”€ */
.q-card{width:100%;max-width:600px;border-radius:20px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.q-hdr{padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
.q-slot-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.18em;opacity:.8}
.q-body{flex:1;padding:clamp(20px,4vw,40px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;text-align:center;min-height:200px}
.q-main{font-family:'Noto Sans JP','DM Sans',sans-serif;font-size:clamp(2rem,7vw,4rem);font-weight:700;line-height:1.2;color:var(--ink);word-break:break-word}
.q-tap-hint{font-size:.7rem;text-transform:uppercase;letter-spacing:.18em;opacity:.4;font-family:'DM Sans',sans-serif;margin-top:8px}
.q-ftr{padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
.q-player-chip{display:flex;align-items:center;gap:6px;font-size:.8rem}
.q-speak-row{display:flex;justify-content:center;margin-top:6px}
.slot-1 .q-hdr,.slot-1 .q-ftr{background:var(--s1bg)}.slot-1 .q-body{background:white}.slot-1 .q-hdr{border-bottom:2px solid var(--s1)}.slot-1 .q-slot-label{color:var(--s1)}
.slot-2 .q-hdr,.slot-2 .q-ftr{background:var(--s2bg)}.slot-2 .q-body{background:white}.slot-2 .q-hdr{border-bottom:2px solid var(--s2)}.slot-2 .q-slot-label{color:var(--s2)}
.slot-3 .q-hdr,.slot-3 .q-ftr{background:var(--s3bg)}.slot-3 .q-body{background:white}.slot-3 .q-hdr{border-bottom:2px solid var(--s3)}.slot-3 .q-slot-label{color:var(--s3)}
.slot-4 .q-hdr,.slot-4 .q-ftr{background:var(--s4bg)}.slot-4 .q-body{background:white}.slot-4 .q-hdr{border-bottom:2px solid var(--s4)}.slot-4 .q-slot-label{color:var(--s4)}
.slot-5 .q-hdr,.slot-5 .q-ftr{background:var(--s5bg)}.slot-5 .q-body{background:white}.slot-5 .q-hdr{border-bottom:2px solid var(--s5)}.slot-5 .q-slot-label{color:var(--s5)}
.steal-card .q-hdr,.steal-card .q-ftr{background:#2c1654}.steal-card .q-body{background:#1a0a33}.steal-card .q-slot-label{color:#e9d5ff}.steal-card .q-main{color:#e9d5ff}

/* â”€â”€ ANSWER CARD â”€â”€ */
.a-card{width:100%;max-width:600px;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:flipIn .25s ease-out}
@keyframes flipIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.a-hdr{padding:14px 20px;display:flex;align-items:center;gap:10px}
.a-hdr-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.18em;opacity:.6;font-family:'DM Sans',sans-serif}
.a-body{padding:clamp(16px,4vw,36px);display:flex;flex-direction:column;align-items:center;gap:10px;background:white;text-align:center}
.a-answer{font-family:'DM Sans',sans-serif;font-size:clamp(1.3rem,4vw,2.2rem);font-weight:700;color:var(--ink);line-height:1.2}
.judge-row{padding:12px 16px;display:flex;gap:10px;background:#f5f5f5}
.jbtn{flex:1;padding:14px;border-radius:12px;border:none;font-size:clamp(1rem,3vw,1.4rem);font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;transition:transform .1s,opacity .2s}
.jbtn:active{transform:scale(.95)}
.jbtn.correct{background:#27ae60;color:white}
.jbtn.wrong{background:#e74c3c;color:white}
.jbtn:disabled{opacity:.35;cursor:not-allowed}

/* â”€â”€ POINTS / WRONG / STEAL â”€â”€ */
.pts-card{background:var(--surface);border:3px solid var(--gold);border-radius:20px;padding:clamp(20px,4vw,40px);display:flex;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:400px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.pts-result{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.4rem,5vw,2.2rem);letter-spacing:.08em;color:#27ae60}
.pts-roll-label{font-size:.8rem;color:rgba(240,235,224,.4)}
.pts-big{font-family:'Bebas Neue',sans-serif;font-size:clamp(3rem,12vw,6rem);color:var(--gold);line-height:1;text-shadow:0 0 40px rgba(245,200,66,.4)}
.next-btn{width:100%;padding:14px;border-radius:12px;border:none;background:var(--gold);color:var(--ink);font-family:'DM Sans',sans-serif;font-weight:700;font-size:1rem;cursor:pointer}
.wrong-card{background:#2a0a0a;border:3px solid #e74c3c;border-radius:20px;padding:clamp(20px,4vw,40px);display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:400px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.wrong-icon{font-size:clamp(2.5rem,8vw,4rem)}
.wrong-label{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.6rem,6vw,2.5rem);letter-spacing:.08em;color:#e74c3c}
.wrong-ans{background:rgba(231,76,60,.15);border:1px solid rgba(231,76,60,.3);border-radius:10px;padding:12px 20px;font-size:clamp(.9rem,2.5vw,1.2rem);color:#f5a5a0;font-family:'Noto Sans JP','DM Sans',sans-serif}
.steal-result-card{background:linear-gradient(135deg,#2c1654,#1a0a33);border:3px solid var(--steal);border-radius:20px;padding:clamp(20px,4vw,40px);display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:400px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.steal-headline{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.8rem,7vw,3rem);letter-spacing:.1em;color:#e9d5ff}
.steal-detail{font-size:.85rem;color:rgba(233,213,255,.6);font-family:'DM Sans',sans-serif}

/* â”€â”€ WIN â”€â”€ */
#win{align-items:center;justify-content:center;gap:0;padding:0;background:var(--bg);overflow:hidden}
.win-inner{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:24px;background:radial-gradient(ellipse at 50% 20%,rgba(245,200,66,.18),transparent 65%)}
.win-confetti{font-size:clamp(1.2rem,4vw,2rem);letter-spacing:.15em;text-align:center;animation:confettiBounce 1s ease-out}
@keyframes confettiBounce{0%{transform:scale(0) rotate(-10deg);opacity:0}60%{transform:scale(1.15) rotate(3deg)}100%{transform:scale(1) rotate(0);opacity:1}}
.win-crown{font-size:clamp(3.5rem,12vw,6rem);text-align:center;animation:crownDrop .6s .2s both cubic-bezier(.17,.67,.24,1.4)}
@keyframes crownDrop{from{transform:translateY(-40px) scale(.5);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.win-label{font-family:'DM Sans',sans-serif;font-size:.7rem;text-transform:uppercase;letter-spacing:.3em;color:rgba(240,235,224,.4);animation:fadeUp .5s .4s both}
.win-name{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.2rem,9vw,4.5rem);letter-spacing:.1em;color:var(--gold);text-align:center;line-height:1;text-shadow:0 0 40px rgba(245,200,66,.5);animation:fadeUp .5s .5s both}
.win-score-badge{background:rgba(245,200,66,.15);border:2px solid rgba(245,200,66,.4);border-radius:50px;padding:8px 24px;font-family:'Bebas Neue',sans-serif;font-size:clamp(1.4rem,5vw,2rem);color:var(--gold);animation:fadeUp .5s .6s both}
.win-jp{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:clamp(.8rem,2.5vw,1.1rem);color:rgba(240,235,224,.4);animation:fadeUp .5s .65s both}
.win-divider{width:60px;height:2px;background:rgba(245,200,66,.25);border-radius:2px;animation:fadeUp .5s .68s both}
.final-list{width:100%;max-width:380px;display:flex;flex-direction:column;gap:5px;animation:fadeUp .5s .7s both}
.fl-row{background:rgba(255,255,255,.05);border-radius:10px;padding:10px 16px;display:flex;align-items:center;gap:10px;font-size:clamp(.82rem,2.5vw,1rem)}
.fl-row.top{background:rgba(245,200,66,.12);border:2px solid rgba(245,200,66,.4)}
.fl-pts{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--gold);margin-left:auto}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ FEEDBACK â”€â”€ */
#feedback{align-items:center;justify-content:flex-start;padding:20px;gap:0;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))}
.fb-wrap{width:100%;max-width:480px;display:flex;flex-direction:column;gap:14px;margin:auto}
.fb-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:.1em;color:var(--gold);text-align:center}
.fb-animal{font-size:2.5rem;text-align:center}
.fb-sub{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:.8rem;color:rgba(240,235,224,.4);text-align:center;letter-spacing:.05em}
.fb-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:18px;display:flex;flex-direction:column;gap:10px}
.fb-q{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:clamp(.95rem,3vw,1.1rem);font-weight:700;color:#f0ebe0;line-height:1.5}
.fb-q-num{font-family:'Bebas Neue',sans-serif;font-size:.9rem;color:var(--gold);letter-spacing:.1em;margin-bottom:2px}
.star-row{display:flex;gap:6px;justify-content:center}
.star-btn{font-size:clamp(1.8rem,7vw,2.5rem);cursor:pointer;transition:transform .15s;filter:grayscale(1);opacity:.4;background:none;border:none;padding:2px}
.star-btn.active{filter:none;opacity:1;transform:scale(1.15)}
.fun-labels{display:flex;justify-content:space-between;font-size:.65rem;color:rgba(240,235,224,.3);font-family:'DM Sans',sans-serif}
.choice-row{display:flex;gap:8px;flex-wrap:wrap}
.choice-btn{flex:1;min-width:80px;padding:10px 8px;border-radius:10px;border:2px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:rgba(240,235,224,.7);font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:clamp(.72rem,2.2vw,.85rem);cursor:pointer;transition:all .15s;text-align:center;line-height:1.4}
.choice-btn.selected{border-color:var(--gold);background:rgba(245,200,66,.15);color:var(--gold);font-weight:700}
.check-row{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.check-btn{padding:12px 10px;border-radius:12px;border:3px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:rgba(240,235,224,.55);font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:clamp(.72rem,2vw,.85rem);cursor:pointer;transition:all .18s;text-align:center;line-height:1.5;position:relative}
.check-btn.selected{border-color:var(--gold);background:rgba(245,200,66,.2);color:#fff;font-weight:700;transform:scale(1.04);box-shadow:0 0 0 3px rgba(245,200,66,.35)}
.check-btn.selected::after{content:'âœ“';position:absolute;top:5px;right:8px;font-size:.75rem;color:var(--gold);font-weight:900}
.fb-submit{background:var(--gold);color:var(--ink);border:none;border-radius:12px;padding:14px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;width:100%;opacity:.4;transition:opacity .2s}
.fb-submit.ready{opacity:1}
.fb-done{background:rgba(39,174,96,.15);border:2px solid #27ae60;border-radius:14px;padding:20px;text-align:center;display:flex;flex-direction:column;gap:8px;align-items:center}
.fb-done-icon{font-size:3rem}
.fb-done-title{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:#27ae60;letter-spacing:.1em}
.fb-done-sub{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:.85rem;color:rgba(240,235,224,.5)}

/* â”€â”€ FEEDBACK DASHBOARD â”€â”€ */
#dashboard{align-items:center;padding:16px;gap:0;background:var(--bg)}
.db-header{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:520px;margin-bottom:14px;flex-shrink:0}
.db-title{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:.1em;color:var(--gold)}
.db-close{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:6px 14px;color:rgba(240,235,224,.5);font-size:.75rem;font-family:'DM Sans',sans-serif;cursor:pointer}
.db-scroll{flex:1;overflow-y:auto;width:100%;display:flex;flex-direction:column;align-items:center}
.db-grid{width:100%;max-width:520px;display:flex;flex-direction:column;gap:12px;padding-bottom:20px}
.db-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
.db-card-title{font-family:'Bebas Neue',sans-serif;font-size:.9rem;letter-spacing:.12em;color:rgba(240,235,224,.4);margin-bottom:10px}
.db-big{font-family:'Bebas Neue',sans-serif;font-size:3rem;color:var(--gold);line-height:1}
.db-stat-row{display:flex;gap:12px}
.db-stat{flex:1;text-align:center;background:rgba(0,0,0,.2);border-radius:10px;padding:10px 6px}
.db-stat-val{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--gold)}
.db-stat-lbl{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:.62rem;color:rgba(240,235,224,.45);line-height:1.4;margin-top:2px}
.db-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.db-bar-lbl{font-size:.7rem;color:rgba(240,235,224,.6);width:120px;flex-shrink:0;font-family:'DM Sans',sans-serif}
.db-bar-track{flex:1;background:rgba(255,255,255,.06);border-radius:4px;height:18px;overflow:hidden}
.db-bar-fill{height:100%;border-radius:4px;transition:width .6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px}
.db-bar-val{font-family:'Bebas Neue',sans-serif;font-size:.75rem;color:rgba(255,255,255,.8)}
.fun-track{width:100%;background:rgba(255,255,255,.06);border-radius:8px;height:24px;overflow:hidden;margin:6px 0}
.fun-fill{height:100%;border-radius:8px;background:linear-gradient(90deg,#e74c3c,#f39c12,#27ae60);transition:width .8s ease}
.db-reset{background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:10px;padding:10px;color:#e74c3c;font-family:'DM Sans',sans-serif;font-size:.8rem;cursor:pointer;width:100%;margin-top:4px}
.db-empty{text-align:center;padding:20px;font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:.9rem;color:rgba(240,235,224,.3)}
.db-responses{font-size:.65rem;color:rgba(240,235,224,.25);text-align:right;margin-top:4px;font-family:'DM Sans',sans-serif}
.db-loading{text-align:center;padding:30px;color:rgba(240,235,224,.4);font-family:'DM Sans',sans-serif}

/* â”€â”€ VOICE â”€â”€ */
.speak-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:50px;padding:6px 14px;font-size:.8rem;cursor:pointer;display:inline-flex;align-items:center;gap:5px;font-family:'DM Sans',sans-serif;color:rgba(240,235,224,.7);transition:all .15s;flex-shrink:0}
.speak-btn.speaking{background:rgba(245,200,66,.2);border-color:var(--gold);color:var(--gold);animation:pulse .8s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.speak-btn-dark{background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.15);color:rgba(26,26,26,.6)}
.speak-btn-dark.speaking{background:rgba(39,174,96,.15);border-color:#27ae60;color:#27ae60}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(0,0,0,.35);border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.bnav-info{font-size:.62rem;font-family:'DM Sans',sans-serif;text-transform:uppercase;letter-spacing:.12em;color:rgba(240,235,224,.25)}
.bnav-btn{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px 14px;color:rgba(240,235,224,.5);font-size:.7rem;font-family:'DM Sans',sans-serif;cursor:pointer}
</style>
</head>
<body>

<!-- â•â• INSTRUCTIONS â•â• -->
<div id="instructions" class="screen active">
  <div class="instr-wrap">
    <div class="instr-dots" id="instr-dots"></div>
    <div class="instr-slide" id="instr-slide"></div>
    <div class="instr-nav">
      <button class="instr-prev" id="instr-prev" onclick="instrPrev()">â† Back</button>
      <button class="instr-next" id="instr-next" onclick="instrNext()">Next â†’</button>
      <button class="instr-skip" onclick="skipInstr()">Skip</button>
    </div>
  </div>
</div>

<!-- â•â• HOME â•â• -->
<div id="home" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:30px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))">
    <div class="logo" id="logo-tap" onclick="logoTap()" style="cursor:pointer;user-select:none">ğŸ²<br>DICE<br>MASTERY</div>
    <div class="logo-sub">Classroom Edition</div>
    <div class="home-btns">
      <button class="btn btn-gold" onclick="goTeacher()">ğŸ  Create a Room</button>
      <div class="home-or">â€” or â€”</div>
      <button class="btn btn-surface" onclick="goStudent()">ğŸ’ Join a Room</button>
    </div>
  </div>
</div>

<!-- â•â• SETUP (teacher) â•â• -->
<div id="setup" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:20px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))">
    <div class="logo" style="font-size:2rem">ğŸ² CREATE ROOM</div>
    <div class="setup-box">
      <h2>GAME SETTINGS</h2>
      <div style="font-size:.75rem;color:rgba(240,235,224,.5);font-family:'DM Sans',sans-serif;text-align:center">Pick your animal</div>
      <div class="animal-pick" id="setup-animal-pick" style="max-width:320px;margin:0 auto">
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸ•')">ğŸ•</button>
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸˆ')">ğŸˆ</button>
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸ¸')">ğŸ¸</button>
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸ”')">ğŸ”</button>
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸ‡')">ğŸ‡</button>
        <button class="animal-btn" onclick="setupPickAnimal(this,'ğŸ„')">ğŸ„</button>
      </div>
      <div class="points-row">
        <label>First to reach:</label>
        <select class="points-select" id="target-pts">
          <option value="10">10 points</option>
          <option value="15">15 points</option>
          <option value="20" selected>20 points</option>
          <option value="30">30 points</option>
        </select>
      </div>
      <button class="btn btn-gold" onclick="createRoom()">ğŸ  Create Room</button>
      <button class="btn btn-ghost" onclick="showHome()">â† Back</button>
    </div>
  </div>
</div>

<!-- â•â• JOIN (student) â•â• -->
<div id="join" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px;background:radial-gradient(ellipse at 50% 0%,#1a3328,var(--bg))">
    <div class="join-title">ğŸ’ JOIN GAME</div>
    <div class="join-sub">ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹</div>
    <input class="code-input" id="room-code-input" type="number" placeholder="0000" maxlength="4" oninput="this.value=this.value.slice(0,4)">
    <div style="font-size:.75rem;color:rgba(240,235,224,.4);font-family:'DM Sans',sans-serif">Enter the 4-digit room code from your teacher</div>
    <div style="font-size:.8rem;color:var(--gold);font-family:'Bebas Neue',sans-serif;letter-spacing:.1em">PICK YOUR ANIMAL / ã©ã†ã¶ã¤ã‚’é¸ã‚“ã§ã­</div>
    <div class="animal-pick" id="animal-pick">
      <button class="animal-btn" onclick="pickAnimal('ğŸ•')">ğŸ•</button>
      <button class="animal-btn" onclick="pickAnimal('ğŸˆ')">ğŸˆ</button>
      <button class="animal-btn" onclick="pickAnimal('ğŸ¸')">ğŸ¸</button>
      <button class="animal-btn" onclick="pickAnimal('ğŸ”')">ğŸ”</button>
      <button class="animal-btn" onclick="pickAnimal('ğŸ‡')">ğŸ‡</button>
      <button class="animal-btn" onclick="pickAnimal('ğŸ„')">ğŸ„</button>
    </div>
    <div class="join-err" id="join-err"></div>
    <button class="btn btn-gold" onclick="joinRoom()" id="join-btn" disabled>Enter Room â†’</button>
    <button class="btn btn-ghost" onclick="showHome()" style="max-width:360px">â† Back</button>
  </div>
</div>

<!-- â•â• LOBBY â•â• -->
<div id="lobby" class="screen">
  <div class="conn-bar"><div class="conn-dot ok pulse" id="conn-dot"></div><span id="conn-label">Connected</span></div>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:24px">
    <div class="lobby-title" id="lobby-title">WAITING ROOM</div>
    <div class="room-code-display" id="room-code-display" style="display:none">
      <div class="room-code-label">Room Code / ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</div>
      <div class="room-code-num" id="room-code-num"></div>
      <div style="font-size:.65rem;color:rgba(240,235,224,.3);margin-top:4px;font-family:'DM Sans',sans-serif">Share this code with your students</div>
    </div>
    <div class="lobby-animals" id="lobby-animals"></div>
    <div class="lobby-waiting" id="lobby-waiting">Waiting for players to join...</div>
    <button class="btn btn-gold" id="start-btn" onclick="hostStartGame()" style="max-width:300px;display:none">â–¶ Start Game</button>
    <button class="btn btn-ghost" id="lobby-back" onclick="leaveRoom()" style="max-width:300px">Leave</button>
  </div>
</div>

<!-- â•â• GAME â•â• -->
<div id="game" class="screen">
  <div class="conn-bar"><div class="conn-dot ok" id="game-conn-dot"></div><span id="game-conn-label">Live</span></div>
  <div class="score-bar" id="score-bar"></div>
  <div class="slide-area" id="slide-area"></div>
  <div class="bottom-nav">
    <div class="bnav-info" id="bnav-info">Round 1</div>
    <button class="bnav-btn" id="leave-game-btn" onclick="leaveRoom()">Leave</button>
  </div>
</div>

<!-- â•â• WIN â•â• -->
<div id="win" class="screen">
  <div class="win-inner">
    <div class="win-confetti">ğŸŠ ğŸ‰ ğŸŠ</div>
    <div class="win-crown" id="win-crown">ğŸ†</div>
    <div class="win-label">WINNER / å„ªå‹è€…</div>
    <div class="win-name" id="win-name"></div>
    <div class="win-score-badge" id="win-score"></div>
    <div class="win-jp" id="win-jp">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
    <div class="win-divider"></div>
    <div class="final-list" id="final-list"></div>
    <button class="btn btn-gold" style="max-width:300px;margin-top:8px" onclick="proceedToFeedback()">ğŸ“ Give Feedback / ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</button>
  </div>
</div>

<!-- â•â• FEEDBACK â•â• -->
<div id="feedback" class="screen">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;padding:20px">
    <div class="fb-wrap">
      <div class="fb-title">ğŸ“ Feedback Dashboard</div>
      <div class="fb-animal" id="fb-animal"></div>
      <div class="fb-sub">åŒ¿åã§ã™ã€‚æ­£ç›´ã«ç­”ãˆã¦ã­ï¼<br>Anonymous â€” be honest!</div>
      <div class="fb-card">
        <div class="fb-q-num">Q1</div>
        <div class="fb-q">ã‚²ãƒ¼ãƒ ã¯æ¥½ã—ã‹ã£ãŸã§ã™ã‹ï¼Ÿ<br><span style="font-size:.75rem;opacity:.5">How fun was the game?</span></div>
        <div class="star-row" id="star-row">
          <button class="star-btn" onclick="setStar(1)">â­</button>
          <button class="star-btn" onclick="setStar(2)">â­</button>
          <button class="star-btn" onclick="setStar(3)">â­</button>
          <button class="star-btn" onclick="setStar(4)">â­</button>
          <button class="star-btn" onclick="setStar(5)">â­</button>
        </div>
        <div class="fun-labels"><span>ã¤ã¾ã‚‰ãªã‹ã£ãŸ</span><span>ã¨ã¦ã‚‚æ¥½ã—ã‹ã£ãŸ</span></div>
      </div>
      <div class="fb-card">
        <div class="fb-q-num">Q2</div>
        <div class="fb-q">é›£ã—ã•ã¯ã©ã†ã§ã—ãŸã‹ï¼Ÿ<br><span style="font-size:.75rem;opacity:.5">How was the difficulty?</span></div>
        <div class="choice-row">
          <button class="choice-btn" onclick="setDiff('too_easy')">ğŸ˜´<br>ç°¡å˜ã™ããŸ</button>
          <button class="choice-btn" onclick="setDiff('just_right')">ğŸ˜Š<br>ã¡ã‚‡ã†ã©ã‚ˆã‹ã£ãŸ</button>
          <button class="choice-btn" onclick="setDiff('too_hard')">ğŸ˜¤<br>é›£ã—ã™ããŸ</button>
        </div>
      </div>
      <div class="fb-card">
        <div class="fb-q-num">Q3</div>
        <div class="fb-q">ã©ã®ã‚«ãƒ¼ãƒ‰ãŒä¸€ç•ªé›£ã—ã‹ã£ãŸã§ã™ã‹ï¼Ÿ<br><span style="font-size:.75rem;opacity:.5">Which slots were hardest? (pick any)</span></div>
        <div class="check-row">
          <button class="check-btn" onclick="toggleSlot('Slot 1 - Visual')">ğŸ–¼<br>Slot 1<br>Visual</button>
          <button class="check-btn" onclick="toggleSlot('Slot 2 - Translation')">ğŸ“–<br>Slot 2<br>Translation</button>
          <button class="check-btn" onclick="toggleSlot('Slot 3 - Spelling')">âœï¸<br>Slot 3<br>Spelling</button>
          <button class="check-btn" onclick="toggleSlot('Slot 4 - Sentence')">ğŸ’¬<br>Slot 4<br>Sentence</button>
          <button class="check-btn" onclick="toggleSlot('Slot 5 - Synthesis')" style="grid-column:1/-1">â­<br>Slot 5<br>Synthesis</button>
        </div>
      </div>
      <div id="fb-submitted-msg" style="display:none" class="fb-done">
        <div class="fb-done-icon">âœ…</div>
        <div class="fb-done-title">Thank you!</div>
        <div class="fb-done-sub">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ï¼</div>
      </div>
      <button class="fb-submit" id="fb-submit" onclick="submitFeedback()" disabled>é€ä¿¡ã™ã‚‹ / Submit âœ“</button>
    </div>
  </div>
</div>

<!-- â•â• FEEDBACK DASHBOARD â•â• -->
<div id="dashboard" class="screen">
  <div class="db-header" style="padding:16px 16px 0;flex-shrink:0">
    <div class="db-title">ğŸ“Š Feedback Dashboard</div>
    <button class="db-close" onclick="showHome()">â† Back</button>
  </div>
  <div class="db-scroll">
    <div class="db-grid" id="db-grid"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyDN_UsjsMQZ-wRluZMBVoyP7c_J7SRWGNg",
  authDomain: "dice-mastery-4910a.firebaseapp.com",
  databaseURL: "https://dice-mastery-4910a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dice-mastery-4910a",
  storageBucket: "dice-mastery-4910a.firebasestorage.app",
  messagingSenderId: "203334683572",
  appId: "1:203334683572:web:5523e538ff6c81862200e1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ANIMALS = ['ğŸ•','ğŸˆ','ğŸ¸','ğŸ”','ğŸ‡','ğŸ„'];
const DIE = ['','âš€','âš','âš‚','âšƒ','âš„','âš…'];
const SLOT_NAMES = {1:'Visual ğŸ–¼',2:'Translation ğŸ“–',3:'Spelling âœï¸',4:'Sentence ğŸ’¬',5:'Synthesis â­'};

const CARDS = {
  1:[
    {q:'ğŸ¥©',i:'What food is this?',a:'Steak'},
    {q:'ğŸ³',i:'What is this?',a:'Fried egg'},
    {q:'ğŸŒ§ï¸',i:'What weather?',a:'Rain / Rainy'},
    {q:'ğŸ„',i:'What animal?',a:'Cow / Bull'},
    {q:'ğŸ‹ï¸',i:'What activity?',a:'Weightlifting'},
    {q:'ğŸšŒ',i:'What vehicle?',a:'Bus'},
    {q:'ğŸŒ¸',i:'What is this?',a:'Cherry blossom'},
    {q:'â•ğŸ”¢',i:'What school subject?',a:'Math / Mathematics'},
    {q:'ğŸ”¬',i:'What subject?',a:'Science'},
    {q:'ğŸ‘¨â€ğŸš€',i:'What job?',a:'Astronaut'},
    {q:'ğŸ‘®',i:'What job?',a:'Police Officer'},
    {q:'ğŸ‘‘',i:'What person?',a:'King'},
    {q:'ğŸ—',i:'What food?',a:'Fried Chicken'},
    {q:'ğŸ°',i:'What building?',a:'Castle'},
    {q:'ğŸ¸',i:'What sport?',a:'Badminton'},
  ],
  2:[
    {q:'ãªãœ',i:'What does this mean in English?',a:'Why'},
    {q:'ã„ã¤',i:'What does this mean?',a:'When'},
    {q:'ã©ã“',i:'What does this mean?',a:'Where'},
    {q:'ã ã‚Œ',i:'What does this mean?',a:'Who'},
    {q:'ã©ã†ã‚„ã£ã¦',i:'What does this mean?',a:'How'},
    {q:'ã„ãã‚‰',i:'What does this mean?',a:'How much'},
    {q:'ã©ã‚Œãã‚‰ã„',i:'What does this mean?',a:'How long / How far'},
    {q:'ãƒ¯ãƒ‹',i:'What does this mean?',a:'Crocodile'},
    {q:'å…«æœˆ',i:'What does this mean?',a:'August'},
    {q:'é‡çƒãƒãƒ¼ãƒ ',i:'What does this mean?',a:'Baseball Team'},
    {q:'ç§‘å­¦',i:'What does this mean?',a:'Science'},
    {q:'é‹å‹•ä¼š',i:'What does this mean?',a:'Sports Day'},
    {q:'æœˆæ›œæ—¥',i:'What does this mean?',a:'Monday'},
    {q:'æ³³ã',i:'What does this mean?',a:'Swim / Swimming'},
    {q:'ãŠã˜ã„ã•ã‚“',i:'What does this mean?',a:'Grandfather'},
  ],
  3:[
    {q:'æœé£Ÿ',i:'Spell it in English.',a:'BÂ·RÂ·EÂ·AÂ·KÂ·FÂ·AÂ·SÂ·T'},
    {q:'å›³æ›¸é¤¨',i:'Spell it in English.',a:'LÂ·IÂ·BÂ·RÂ·AÂ·RÂ·Y'},
    {q:'ç—…é™¢',i:'Spell it in English.',a:'HÂ·OÂ·SÂ·PÂ·IÂ·TÂ·AÂ·L'},
    {q:'é§…',i:'Spell it in English.',a:'SÂ·TÂ·AÂ·TÂ·IÂ·OÂ·N'},
    {q:'å­¦æ ¡',i:'Spell it in English.',a:'SÂ·CÂ·HÂ·OÂ·OÂ·L'},
    {q:'å‹é”',i:'Spell it in English.',a:'FÂ·RÂ·IÂ·EÂ·NÂ·D'},
    {q:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',i:'Spell it in English.',a:'RÂ·EÂ·SÂ·TÂ·AÂ·UÂ·RÂ·AÂ·NÂ·T'},
    {q:'é’',i:'Spell it in English.',a:'BÂ·LÂ·UÂ·E'},
    {q:'å¸½å­',i:'Spell it in English.',a:'CÂ·AÂ·P'},
    {q:'çŒ«',i:'Spell it in English.',a:'CÂ·AÂ·T'},
    {q:'ã‚¨ã‚¸ãƒ—ãƒˆ',i:'Spell this country.',a:'EÂ·GÂ·YÂ·PÂ·T'},
    {q:'ä¸­å›½',i:'Spell this country.',a:'CÂ·HÂ·IÂ·NÂ·A'},
    {q:'å…­æœˆ',i:'Spell this month.',a:'JÂ·UÂ·NÂ·E'},
    {q:'ãƒ’ãƒ¼ãƒ­ãƒ¼',i:'Spell it in English.',a:'HÂ·EÂ·RÂ·O'},
    {q:'ãƒãƒ³',i:'Spell this vehicle.',a:'VÂ·AÂ·N'},
  ],
  4:[
    {q:'ç§ã¯ãµã ã‚“å®¿é¡Œã‚’ã—ã¾ã™ã€‚',i:'Translate to English.',a:'"I usually do my homework."'},
    {q:'å½¼å¥³ã¯æ¯æ—¥è‹±èªã‚’å‹‰å¼·ã—ã¾ã™ã€‚',i:'Translate to English.',a:'"She studies English every day."'},
    {q:'ç§ãŸã¡ã¯å…¬åœ’ã§éŠã³ã¾ã™ã€‚',i:'Translate to English.',a:'"We play in the park."'},
    {q:'å½¼ã¯éŸ³æ¥½ã‚’è´ãã®ãŒå¥½ãã§ã™ã€‚',i:'Translate to English.',a:'"He likes listening to music."'},
    {q:'ä»Šæ—¥ã¯å¤©æ°—ãŒã„ã„ã§ã™ã€‚',i:'Translate to English.',a:'"The weather is good today."'},
    {q:'ç§ã¯å°†æ¥ã€åŒ»è€…ã«ãªã‚ŠãŸã„ã§ã™ã€‚',i:'Translate to English.',a:'"I want to become a doctor."'},
    {q:'é€±æœ«ã«å®¶æ—ã¨è²·ã„ç‰©ã«è¡Œãã¾ã—ãŸã€‚',i:'Translate to English.',a:'"I went shopping with my family."'},
    {q:'ç§ã¯ä½“è‚²ãŒå¥½ãã§ã™ã€‚',i:'Translate to English.',a:'"I like P.E."'},
    {q:'ç§ã¯é€Ÿãèµ°ã‚Œã¾ã›ã‚“ã€‚',i:'Translate to English.',a:'"I cannot run fast."'},
    {q:'å½¼å¥³ã¯ç§ã®æ¯ã§ã™ã€‚',i:'Translate to English.',a:'"She is my mother."'},
    {q:'ç§ãŸã¡ã«ã¯ç´ æ•µãªå…¬åœ’ãŒã‚ã‚Šã¾ã™ã€‚',i:'Translate to English.',a:'"We have a nice park."'},
    {q:'å·¦å´ã«è¦‹ãˆã¾ã™ã‚ˆã€‚',i:'Translate to English.',a:'"You can see it on your left."'},
    {q:'ä¸­è¯è¡—ã‚’è¦‹ãŸã„ã§ã™ã€‚',i:'Translate to English.',a:'"I want to see Chinatown."'},
    {q:'å½¼ã¯æ­Œã†ã®ãŒå¾—æ„ã§ã™ã€‚',i:'Translate to English.',a:'"He is good at singing."'},
    {q:'å½¼å¥³ã¯ç§ã®å‹é”ã§ã™ã€‚',i:'Translate to English.',a:'"She is my friend."'},
  ],
  5:[
    {q:'"My favorite _____ is _____."',i:'Complete the sentence aloud.',a:'My favorite [noun] is [answer].'},
    {q:'3 things you did yesterday',i:'Say in English using past tense.',a:'I [verb]ed... I [verb]ed... I [verb]ed...'},
    {q:"Today\'s weather",i:'Describe in one full sentence.',a:'The weather is [adjective] today.'},
    {q:'"I enjoy ___ing..."',i:'Complete and say aloud.',a:'I enjoy [verb]ing...'},
    {q:'Introduce yourself',i:'Two sentences about you.',a:'My name is... I am... / I like...'},
    {q:'Your weekend plans',i:'Use "will".',a:'I will [verb]... this weekend.'},
    {q:'Compare two things',i:'Use "better than because".',a:'[X] is better than [Y] because...'},
    {q:'"I want to go to _____."',i:'Complete aloud.',a:'I want to go to [place].'},
    {q:'"I like _____."',i:'Complete aloud.',a:'I like [noun / verb+ing].'},
    {q:'"My birthday is _____."',i:'Complete aloud.',a:'My birthday is [month] [day].'},
    {q:'"I\'d like _____ and _____."',i:'Complete aloud.',a:'I\'d like [item] and [item].'},
    {q:'"I want to go ___ing."',i:'Complete aloud.',a:'I want to go [verb]ing.'},
    {q:'"I want a _____."',i:'Complete aloud.',a:'I want a [noun].'},
    {q:'"I can _____."',i:'Complete aloud.',a:'I can [base verb].'},
    {q:'"He / She is _____."',i:'Complete aloud.',a:'He / She is [adjective / noun].'},
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let instrIdx = 0;
let isHost = false;
let myAnimal = null;
let roomId = null;
let roomRef = null;
let gameStateRef = null;
let gameListener = null;
let lobbyListener = null;
let sessionId = null;

let localDeck = {};
let localPhase = 'roll';
let localCurrentCard = null;
let localCurrentIdx = 0;
let localPlayers = [];
let localScores = {};
let localRound = 1;
let localTargetPts = 20;
let stealVictim = null;
let stealAmt = 0;
let isMyTurn = false;
let fbSubmitted = false;
let fbStar = 0, fbDiff = '', fbSlots = new Set();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let voices = [], preferredVoice = null;
function initVoice(){
  if(!('speechSynthesis' in window)) return;
  const load = () => {
    voices = window.speechSynthesis.getVoices();
    const preferred = ['Samantha','Karen','Moira','Google US English','Microsoft Zira','en-US','en-GB'];
    for(const n of preferred){
      const v = voices.find(v=>v.name.includes(n)||v.lang.startsWith(n));
      if(v){ preferredVoice=v; break; }
    }
    if(!preferredVoice) preferredVoice = voices.find(v=>v.lang.startsWith('en'))||voices[0];
  };
  load();
  window.speechSynthesis.onvoiceschanged = load;
}
function speak(text){
  if(!('speechSynthesis' in window)||!text) return;
  window.speechSynthesis.cancel();
  const clean = text.replace(/[\u{1F000}-\u{1FFFF}]/gu,'').replace(/[\u3000-\u9FFF\u3040-\u30FF]/g,'').replace(/[Â·â€¢â˜…âœ¦"'""'']/g,'').replace(/\s+/g,' ').trim();
  if(!clean) return;
  const utt = new SpeechSynthesisUtterance(clean);
  utt.lang='en-US'; utt.rate=0.88; utt.pitch=1.0; utt.volume=1.0;
  if(preferredVoice) utt.voice=preferredVoice;
  utt.onend=()=>document.querySelectorAll('.speak-btn').forEach(b=>b.classList.remove('speaking'));
  utt.onerror=()=>document.querySelectorAll('.speak-btn').forEach(b=>b.classList.remove('speaking'));
  document.querySelectorAll('.speak-btn').forEach(b=>b.classList.add('speaking'));
  window.speechSynthesis.speak(utt);
}
function speakJP(text){
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang='ja-JP'; utt.rate=0.85;
  const jpV = voices.find(v=>v.lang==='ja-JP'||v.lang.startsWith('ja'));
  if(jpV) utt.voice=jpV;
  window.speechSynthesis.speak(utt);
}
function speakCard(card){
  if(!card) return;
  const isEmoji = /^[\p{Emoji}\s]+$/u.test(card.q.trim());
  const isJP = /[\u3040-\u9FFF]/.test(card.q);
  if(isEmoji) return;
  if(isJP){ speakJP(card.q); return; }
  speak(card.q);
}
function speakAnswer(card){
  if(!card) return;
  const isJP = /[\u3040-\u9FFF]/.test(card.q);
  const isEmoji = /^[\p{Emoji}\s]+$/u.test(card.q.trim());
  const qText = (!isJP && !isEmoji) ? card.q + '... ' : '';
  speak(qText + card.a);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INSTRUCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INSTR_SLIDES = [
  {icon:'ğŸ²',en:'WELCOME TO DICE MASTERY',bodyEn:'A classroom English game for up to 6 players.<br>Answer questions, earn points, steal from your rivals!',jp:'ãƒ€ã‚¤ã‚¹ãƒ»ãƒã‚¹ã‚¿ãƒªãƒ¼ã¸ã‚ˆã†ã“ãï¼',bodyJp:'æœ€å¤§6äººã§éŠã¹ã‚‹è‹±èªã®æˆæ¥­ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>è³ªå•ã«ç­”ãˆã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç¨¼ãã€ãƒ©ã‚¤ãƒãƒ«ã‹ã‚‰å¥ªã„å–ã‚ã†ï¼',extra:null},
  {icon:'ğŸ†',en:'HOW TO WIN',bodyEn:'Be the first player to reach the target score.<br>The teacher sets the target â€” 10, 15, 20 or 30 points.',jp:'å‹ã¡æ–¹',bodyJp:'ç›®æ¨™ãƒã‚¤ãƒ³ãƒˆã«æœ€åˆã«åˆ°é”ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹ã¡ã§ã™ã€‚<br>å…ˆç”ŸãŒç›®æ¨™ã‚’è¨­å®šã—ã¾ã™ï¼ˆ10ãƒ»15ãƒ»20ãƒ»30ç‚¹ï¼‰ã€‚',extra:null},
  {icon:'ğŸ“‹',en:'THE 5 CARD SLOTS',bodyEn:'Roll the die â€” the number (1â€“5) tells you which card slot to draw from.<br>Roll a âš… 6 and it is a steal!<br><strong>All answers are spoken aloud â€” the teacher judges every card.</strong>',jp:'5ã¤ã®ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆ',bodyJp:'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™ â€” å‡ºãŸç›®ï¼ˆ1ã€œ5ï¼‰ãŒã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã®ç•ªå·ã§ã™ã€‚<br>âš… 6ãŒå‡ºãŸã‚‰ã‚¹ãƒãƒ¼ãƒ«ï¼<br><strong>ã™ã¹ã¦ã®ç­”ãˆã¯å£°ã«å‡ºã—ã¦è¨€ã„ã¾ã™ â€” å…ˆç”ŸãŒã™ã¹ã¦åˆ¤å®šã—ã¾ã™ã€‚</strong>',extra:'slots'},
  {icon:'ğŸ¯',en:'YOUR TURN â€” 4 STEPS',bodyEn:'<strong>â‘  Roll</strong> the die â€” the number picks your card slot.<br><strong>â‘¡ Read</strong> the card question aloud.<br><strong>â‘¢ Answer</strong> â€” say it aloud! Teacher taps âœ… æ­£è§£ or âŒ ä¸æ­£è§£.<br><strong>â‘£ Roll again</strong> for points if correct!',jp:'ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ â€” 4ã‚¹ãƒ†ãƒƒãƒ—',bodyJp:'<strong>â‘  ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</strong> â€” å‡ºãŸç›®ãŒã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã®ç•ªå·ã€‚<br><strong>â‘¡ ã‚«ãƒ¼ãƒ‰ã‚’èª­ã‚€</strong> â€” è³ªå•ã‚’å£°ã«å‡ºã—ã¦èª­ã¿ã¾ã—ã‚‡ã†ã€‚<br><strong>â‘¢ ç­”ãˆã‚‹</strong> â€” å£°ã«å‡ºã—ã¦è¨€ã„ã¾ã—ã‚‡ã†ï¼å…ˆç”ŸãŒâœ…æ­£è§£ã¾ãŸã¯âŒä¸æ­£è§£ã‚’æŠ¼ã—ã¾ã™ã€‚<br><strong>â‘£ å†åº¦æŒ¯ã‚‹</strong> â€” æ­£è§£ã—ãŸã‚‰ãƒã‚¤ãƒ³ãƒˆã®ãŸã‚ã«ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚Šã¾ã™ï¼',extra:null},
  {icon:'ğŸ¯',en:'ROLL A 6 â€” STEAL!',bodyEn:'Roll a <strong>âš… 6</strong> on the movement die to trigger a steal!<br>Answer the card correctly, then roll again â€” steal that many points from the player with the most points!<br><span style="color:#f5837a;font-size:.85em">âš  Their score can go negative!</span>',jp:'6ã‚’å‡ºã—ãŸã‚‰ã‚¹ãƒãƒ¼ãƒ«ï¼',bodyJp:'ç§»å‹•ã®ã‚µã‚¤ã‚³ãƒ­ã§<strong>âš… 6</strong>ãŒå‡ºãŸã‚‰ã‚¹ãƒãƒ¼ãƒ«ç™ºå‹•ï¼<br>ã‚«ãƒ¼ãƒ‰ã«æ­£è§£ã—ãŸã‚‰ã€ã‚‚ã†ä¸€åº¦ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦æœ€ã‚‚ãƒã‚¤ãƒ³ãƒˆã®é«˜ã„ç›¸æ‰‹ã‹ã‚‰ãã®æ•°ã‚’å¥ªã„ã¾ã™ï¼<br><span style="color:#f5837a;font-size:.85em">âš  ç›¸æ‰‹ã®ã‚¹ã‚³ã‚¢ã¯ãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ï¼</span>',extra:null},
];
function renderInstrSlide(){
  const s=INSTR_SLIDES[instrIdx], total=INSTR_SLIDES.length;
  document.getElementById('instr-dots').innerHTML=INSTR_SLIDES.map((_,i)=>`<div class="instr-dot${i===instrIdx?' on':''}"></div>`).join('');
  const nextBtn=document.getElementById('instr-next');
  nextBtn.textContent=instrIdx===total-1?'Lets Play! â†’':'Next â†’';
  document.getElementById('instr-prev').disabled=instrIdx===0;
  let extra='';
  if(s.extra==='slots'){
    extra=`<div class="instr-slots">
      <div class="instr-slot-chip" style="background:rgba(41,128,185,.15);border:1px solid rgba(41,128,185,.3)"><span class="sc-icon">ğŸ–¼</span><div class="sc-text"><span class="sc-en" style="color:#7ec8f5">Slot 1 Â· Visual</span><span class="sc-jp">çµµã‚’è¦‹ã¦ç­”ãˆã‚‹</span></div></div>
      <div class="instr-slot-chip" style="background:rgba(39,174,96,.15);border:1px solid rgba(39,174,96,.3)"><span class="sc-icon">ğŸ“–</span><div class="sc-text"><span class="sc-en" style="color:#6edd9f">Slot 2 Â· Translation</span><span class="sc-jp">æ—¥æœ¬èªâ†’è‹±èªã«è¨³ã™</span></div></div>
      <div class="instr-slot-chip" style="background:rgba(201,152,10,.15);border:1px solid rgba(201,152,10,.3)"><span class="sc-icon">âœï¸</span><div class="sc-text"><span class="sc-en" style="color:#f5c842">Slot 3 Â· Spelling</span><span class="sc-jp">è‹±èªã®ã‚¹ãƒšãƒ«ã‚’è¨€ã†</span></div></div>
      <div class="instr-slot-chip" style="background:rgba(230,126,34,.15);border:1px solid rgba(230,126,34,.3)"><span class="sc-icon">ğŸ’¬</span><div class="sc-text"><span class="sc-en" style="color:#f5a55a">Slot 4 Â· Sentence</span><span class="sc-jp">æ–‡ç« ã‚’è‹±èªã«è¨³ã™</span></div></div>
      <div class="instr-slot-chip" style="background:rgba(231,76,60,.15);border:1px solid rgba(231,76,60,.3);grid-column:1/-1"><span class="sc-icon">â­</span><div class="sc-text"><span class="sc-en" style="color:#f5837a">Slot 5 Â· Synthesis</span><span class="sc-jp">è‡ªç”±ã«ç­”ãˆã‚‹</span></div></div>
    </div>`;
  }
  document.getElementById('instr-slide').innerHTML=`<div class="instr-icon">${s.icon}</div><div class="instr-en">${s.en}</div><div class="instr-body-en">${s.bodyEn}</div>${extra}<div class="instr-divider"></div><div class="instr-jp">${s.jp}</div><div class="instr-body-jp">${s.bodyJp}</div>`;
}
function instrNext(){ if(instrIdx<INSTR_SLIDES.length-1){ instrIdx++; renderInstrSlide(); } else { skipInstr(); } }
function instrPrev(){ if(instrIdx>0){ instrIdx--; renderInstrSlide(); } }
function skipInstr(){ showHome(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function showHome(){ showScreen('home'); }
function goTeacher(){ showScreen('setup'); }
function goStudent(){ showScreen('join'); resetJoinUI(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOM CREATION (teacher)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createRoom(){
  if(!selectedAnimal){ alert('Pick your animal first!'); return; }
  const code = String(Math.floor(1000+Math.random()*9000));
  roomId = code;
  sessionId = code + '_' + Date.now();
  isHost = true;
  myAnimal = selectedAnimal;
  localTargetPts = parseInt(document.getElementById('target-pts').value);

  roomRef = db.ref('rooms/' + roomId);
  await roomRef.set({
    config:{ targetPts: localTargetPts, createdAt: Date.now(), sessionId },
    gameState:{ phase:'lobby', scores:{}, round:1, currentAnimal:null, currentCard:null },
    players:{ [encodeAnimal(myAnimal)]: { animal: myAnimal, joinedAt: Date.now() } },
    feedback:{}
  });

  // Clean up room after 3 hours
  roomRef.child('config/expiresAt').set(Date.now() + 3*60*60*1000);

  showLobby();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOIN ROOM (student)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedAnimal = null;
function setupPickAnimal(btn, a){
  selectedAnimal = a;
  document.querySelectorAll('#setup-animal-pick .animal-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
}

function resetJoinUI(){
  selectedAnimal = null;
  document.getElementById('room-code-input').value = '';
  document.getElementById('join-err').textContent = '';
  document.getElementById('join-btn').disabled = true;
  document.querySelectorAll('.animal-btn').forEach(b=>{ b.classList.remove('selected','taken'); });
}
function pickAnimal(a){
  selectedAnimal = a;
  document.querySelectorAll('.animal-btn').forEach(b=>b.classList.remove('selected'));
  const btns = document.querySelectorAll('.animal-btn');
  ANIMALS.forEach((an,i)=>{ if(an===a && !btns[i].classList.contains('taken')) btns[i].classList.add('selected'); });
  checkJoinReady();
}
function checkJoinReady(){
  const code = document.getElementById('room-code-input').value;
  document.getElementById('join-btn').disabled = !(code.length===4 && selectedAnimal);
}
document.getElementById('room-code-input').addEventListener('input', ()=>{
  checkJoinReady();
  // Check taken animals when code is 4 digits
  const code = document.getElementById('room-code-input').value;
  if(code.length===4) checkTakenAnimals(code);
});
async function checkTakenAnimals(code){
  try {
    const snap = await db.ref('rooms/'+code+'/players').once('value');
    const taken = snap.val() ? Object.keys(snap.val()) : [];
    document.querySelectorAll('.animal-btn').forEach((b,i)=>{
      const an = ANIMALS[i];
      b.classList.toggle('taken', taken.includes(an));
      if(taken.includes(an) && selectedAnimal===an){ selectedAnimal=null; b.classList.remove('selected'); checkJoinReady(); }
    });
  } catch(e){}
}
async function joinRoom(){
  const code = document.getElementById('room-code-input').value;
  const errEl = document.getElementById('join-err');
  if(!code||code.length!==4){ errEl.textContent='4æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„'; return; }
  if(!selectedAnimal){ errEl.textContent='ã©ã†ã¶ã¤ã‚’é¸ã‚“ã§ã­ï¼'; return; }
  errEl.textContent = '...';
  try {
    const snap = await db.ref('rooms/'+code).once('value');
    if(!snap.exists()){ errEl.textContent='Room not found. Check the code!'; return; }
    const taken = snap.val().players || {};
    if(taken[selectedAnimal]){ errEl.textContent='That animal is taken! Pick another.'; return; }
    const phase = snap.val().gameState?.phase;
    if(phase && phase !== 'lobby'){ errEl.textContent='Game already started!'; return; }

    roomId = code;
    isHost = false;
    myAnimal = selectedAnimal;
    roomRef = db.ref('rooms/' + roomId);
    localTargetPts = snap.val().config?.targetPts || 20;
    sessionId = snap.val().config?.sessionId;

    await roomRef.child('players/'+encodeAnimal(myAnimal)).set({ animal: myAnimal, joinedAt: Date.now() });
    errEl.textContent = '';
    showLobby();
  } catch(e){ errEl.textContent = 'Connection error. Try again.'; console.error(e); }
}
function encodeAnimal(a){ return a.codePointAt(0).toString(16); }
function decodeAnimal(hex){ return String.fromCodePoint(parseInt(hex,16)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLobby(){
  showScreen('lobby');
  if(isHost){
    document.getElementById('room-code-display').style.display='block';
    document.getElementById('room-code-num').textContent = roomId;
    document.getElementById('start-btn').style.display='block';
    document.getElementById('lobby-title').textContent = 'WAITING ROOM';
  } else {
    document.getElementById('room-code-display').style.display='none';
    document.getElementById('start-btn').style.display='none';
    document.getElementById('lobby-title').textContent = 'JOINED! Waiting to start...';
  }
  renderLobbyAnimals([]);

  // Listen for players joining
  if(lobbyListener) lobbyListener();
  lobbyListener = roomRef.child('players').on('value', snap=>{
    const players = snap.val() || {};
    const animals = Object.values(players).map(p=>p.animal);
    renderLobbyAnimals(animals);
  });

  // Listen for game start
  roomRef.child('gameState/phase').on('value', snap=>{
    const phase = snap.val();
    if(phase && phase !== 'lobby'){ startListeningGame(); }
  });
}

function renderLobbyAnimals(joined){
  const el = document.getElementById('lobby-animals');
  el.innerHTML = ANIMALS.map(a=>{
    const isJoined = joined.includes(a);
    const isMe = a === myAnimal;
    return `<div class="lobby-animal${isJoined?' joined':''}">
      <div class="lobby-animal-icon">${a}</div>
      <div class="lobby-animal-label">${isJoined?(isMe?'You':'Joined'):'Empty'}</div>
      ${isMe?'<div class="lobby-you">YOU</div>':''}
    </div>`;
  }).join('');
  document.getElementById('lobby-waiting').textContent = joined.length > 0 ? `${joined.length} player${joined.length>1?'s':''} joined` : 'Waiting for players...';
}

async function hostStartGame(){
  if(!isHost) return;
  // Get all joined players
  const snap = await roomRef.child('players').once('value');
  const players = snap.val() || {};
  const animalList = Object.values(players).map(p=>p.animal);

  if(animalList.length < 1){ alert('Need at least 1 player to start!'); return; }

  const scores = {};
  animalList.forEach(a=>{ scores[encodeAnimal(a)] = 0; });

  await roomRef.child('gameState').set({
    phase: 'roll',
    animalList,
    currentAnimal: animalList[0],
    scores,
    round: 1,
    currentCard: null,
    targetPts: localTargetPts
  });

  // Init local state for host
  localPlayers = animalList;
  localScores = {};
  animalList.forEach(a=>{ localScores[a]=0; });
  localCurrentIdx = 0;
  localRound = 1;
  localDeck = {};
  for(let s=1;s<=5;s++) localDeck[s]=shuffle([...Array(CARDS[s].length).keys()]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startListeningGame(){
  showScreen('game');
  if(gameListener) roomRef.child('gameState').off('value', gameListener);
  gameListener = roomRef.child('gameState').on('value', snap=>{
    const state = snap.val();
    if(!state) return;
    syncFromState(state);
  });
}

function syncFromState(state){
  localPhase = state.phase;
  localPlayers = state.animalList || [];
  localCurrentIdx = localPlayers.indexOf(state.currentAnimal);
  isMyTurn = (state.currentAnimal === myAnimal);
  localRound = state.round || 1;
  localTargetPts = state.targetPts || 20;

  // Sync scores
  localScores = {};
  if(state.scores){
    Object.entries(state.scores).forEach(([hex,pts])=>{ localScores[decodeAnimal(hex)]=pts; });
  }

  // Sync current card
  localCurrentCard = state.currentCard || null;

  if(state.phase === 'win'){ showWinScreen(state); return; }
  if(state.phase === 'feedback'){ proceedToFeedback(); return; }

  renderGameFromState(state);
}

function renderGameFromState(state){
  renderScoreBar();
  document.getElementById('bnav-info').textContent = `Round ${localRound}`;
  const area = document.getElementById('slide-area');
  const currentAnimal = state.currentAnimal;
  const amActive = isHost; // only teacher controls the game
  const p = { animal: currentAnimal, name: currentAnimal };

  if(state.phase === 'roll'){
    area.innerHTML = `
      <div class="roll-card">
        <div class="turn-label">It's your turn!</div>
        <div class="turn-animal">${currentAnimal}</div>
        <div class="roll-instruction">Roll 1â€“5 to move Â· Roll âš… 6 to STEAL!</div>
        <div class="die-btn${(isMyTurn||isHost)?'':' disabled-die'}" id="move-die" onclick="${(isMyTurn||isHost)?'hostRollMove()':''}">ğŸ²</div>
        ${!isMyTurn && !isHost?`<div class="watching-label">ğŸ‘ Watching ${localPlayers[localCurrentIdx]||''}...</div>`:'<div class="watching-label" style="opacity:0">_</div>'}
      </div>`;
  }
  else if(state.phase === 'question'){
    const c = state.currentCard;
    if(!c){ return; }
    const isSteal = c.steal;
    const cls = isSteal?'steal-card':`slot-${c.slot}`;
    const slotLabel = isSteal?'ğŸ¯ STEAL!':SLOT_NAMES[c.slot];
    area.innerHTML = `
      <div class="q-card ${cls}" onclick="${amActive?'hostRevealAnswer()':''}">
        <div class="q-hdr"><span class="q-slot-label">${slotLabel}</span><span>${currentAnimal}</span></div>
        <div class="q-body">
          <div class="q-main">${c.q}</div>
          ${c.slot!==1?`<div class="q-speak-row"><button class="speak-btn" onclick="event.stopPropagation();replaySpeakCard()">ğŸ”Š Hear</button></div>`:''}
          <div class="q-tap-hint">${(isMyTurn||isHost)?'tap to reveal answer':'waiting for '+localPlayers[localCurrentIdx]+'...'}</div>
        </div>
        <div class="q-ftr"><div class="q-player-chip"><span>${currentAnimal}</span></div><div style="font-size:.65rem;opacity:.4">Slot ${c.slot}</div></div>
      </div>`;
    if(c.slot!==1) setTimeout(()=>speakCard(c), 300);
  }
  else if(state.phase === 'answer'){
    const c = state.currentCard;
    if(!c){ return; }
    const color=['','var(--s1)','var(--s2)','var(--s3)','var(--s4)','var(--s5)'][c.slot]||'#888';
    area.innerHTML = `
      <div class="a-card slot-${c.slot}">
        <div class="a-hdr" style="background:${color}20;border-bottom:2px solid ${color}">
          <span style="font-size:1.2rem">${currentAnimal}</span>
          <div><div class="a-hdr-label">${SLOT_NAMES[c.slot]}</div></div>
        </div>
        <div class="a-body">
          <div style="font-size:.7rem;text-transform:uppercase;letter-spacing:.15em;color:rgba(26,26,26,.35);font-family:'DM Sans',sans-serif;margin-bottom:6px">Model Answer / æ¨¡ç¯„è§£ç­”</div>
          <div class="a-answer" style="font-size:clamp(1.3rem,4vw,2.2rem)">${c.a}</div>
          <div style="display:flex;justify-content:center;margin-top:10px"><button class="speak-btn speak-btn-dark" onclick="speakAnswer(localCurrentCard)">ğŸ”Š Hear it</button></div>
        </div>
        <div style="background:#f9f9f9;padding:8px 14px;text-align:center;font-size:.72rem;color:rgba(26,26,26,.4);font-family:'Noto Sans JP','DM Sans',sans-serif">å…ˆç”ŸãŒåˆ¤å®šã—ã¾ã™ / Teacher judges</div>
        <div class="judge-row"><button class="jbtn correct" id="judge-correct-btn" onclick="hostJudgeCorrect()">âœ… æ­£è§£</button><button class="jbtn wrong" id="judge-wrong-btn" onclick="hostJudgeWrong()">âŒ ä¸æ­£è§£</button></div>
      </div>`;
    setTimeout(()=>speakAnswer(c), 300);
  }
  else if(state.phase === 'points'){
    area.innerHTML = `
      <div class="pts-card">
        <div class="pts-result">âœ… CORRECT!</div>
        <div class="turn-animal">${currentAnimal}</div>
        <div class="pts-roll-label">${currentAnimal} â€” ${amActive?'tap the die to earn points':'waiting...'}</div>
        <div class="die-btn${(isMyTurn||isHost)?'':' disabled-die'}" id="pts-die" onclick="${(isMyTurn||isHost)?'hostRollPoints()':''}">ğŸ²</div>
      </div>`;
  }
  else if(state.phase === 'wrong'){
    const c = state.currentCard;
    area.innerHTML = `
      <div class="wrong-card">
        <div class="wrong-icon">âŒ</div>
        <div class="wrong-label">INCORRECT</div>
        <div style="font-size:.7rem;text-transform:uppercase;letter-spacing:.12em;color:rgba(240,235,224,.35);margin-bottom:4px">Model Answer</div>
        <div class="wrong-ans">${c?c.a:''}</div>
        <button class="speak-btn" style="margin-top:6px" onclick="speakAnswer(localCurrentCard)">ğŸ”Š Hear it</button>
        <button class="next-btn" style="margin-top:10px;background:#e74c3c;color:white" onclick="hostNextPlayer()">Next Player â†’</button>
      </div>`;
    setTimeout(()=>{ if(c) speakAnswer(c); }, 400);
  }
  else if(state.phase === 'steal'){
    const victim = state.stealVictim;
    area.innerHTML = `
      <div class="steal-result-card">
        <div style="font-size:2.5rem">ğŸ¯</div>
        <div class="steal-headline">STEAL!</div>
        <div class="turn-animal">${currentAnimal}</div>
        <div class="steal-detail">${currentAnimal} answered correctly!<br>Tap die to steal from <strong>${victim||'?'}</strong></div>
        <div class="die-btn${(isMyTurn||isHost)?'':' disabled-die'}" id="steal-die" onclick="${(isMyTurn||isHost)?'hostRollSteal()':''}">ğŸ²</div>
      </div>`;
  }
  else if(state.phase === 'steal_result'){
    const victim = state.stealVictim;
    const amt = state.stealAmt || 0;
    const victimScore = localScores[victim] || 0;
    area.innerHTML = `
      <div class="steal-result-card">
        <div style="font-size:2.5rem">ğŸ’¸</div>
        <div class="steal-headline">${currentAnimal} STEALS ${amt}!</div>
        <div class="steal-detail">âˆ’${amt} from ${victim}<br>${victim} now has ${victimScore} pts</div>
        <button class="next-btn" style="margin-top:12px" onclick="hostNextPlayer()">Next Player â†’</button>
      </div>`;
  }
}

function replaySpeakCard(){ if(localCurrentCard) speakCard(localCurrentCard); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOST GAME ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]; } return a; }
function d6(){ return Math.ceil(Math.random()*6); }
function drawCard(slot){
  if(!localDeck[slot]||localDeck[slot].length===0) localDeck[slot]=shuffle([...Array(CARDS[slot].length).keys()]);
  const idx=localDeck[slot].pop();
  return {...CARDS[slot][idx], slot};
}

function hostRollMove(){
  const state_check = roomRef ? true : false;
  if(!state_check) return;
  const die = document.getElementById('move-die');
  if(!die||die.classList.contains('disabled-die')) return;
  die.classList.add('rolling');
  setTimeout(async ()=>{
    die.classList.remove('rolling');
    const roll = d6();
    die.textContent = DIE[roll];

    if(roll === 6){
      // Steal!
      const card = drawCard(Math.ceil(Math.random()*5));
      card.steal = true;
      setTimeout(async()=>{
        await roomRef.child('gameState').update({ phase:'question', currentCard: card });
      }, 600);
      return;
    }

    const slot = ((roll-1)%5)+1;
    const card = drawCard(slot);
    setTimeout(async()=>{
      await roomRef.child('gameState').update({ phase:'question', currentCard: card });
    }, 400);
  }, 480);
}

function hostRevealAnswer(){
  if(!isHost) return;
  roomRef.child('gameState/phase').set('answer');
}

async function hostJudgeCorrect(){
  document.querySelectorAll('.jbtn').forEach(b=>b.disabled=true);
  // Check not already judged
  const curPhase = (await roomRef.child('gameState/phase').once('value')).val();
  if(curPhase !== 'answer') return; // already judged by another device
  const state = (await roomRef.child('gameState').once('value')).val();
  const card = state.currentCard;

  if(card && card.steal){
    // Find victim â€” player with most points (not current)
    const curAnimal = state.currentAnimal;
    const others = localPlayers.filter(a=>a!==curAnimal);
    if(!others.length){ await roomRef.child('gameState/phase').set('points'); return; }
    const victim = others.reduce((best,a)=> (localScores[a]||0)>(localScores[best]||0)?a:best, others[0]);
    await roomRef.child('gameState').update({ phase:'steal', stealVictim: victim });
  } else {
    await roomRef.child('gameState/phase').set('points');
  }
}

async function hostJudgeWrong(){
  document.querySelectorAll('.jbtn').forEach(b=>b.disabled=true);
  const curPhase = (await roomRef.child('gameState/phase').once('value')).val();
  if(curPhase !== 'answer') return;
  await roomRef.child('gameState/phase').set('wrong');
}

function hostRollPoints(){
  if(!isMyTurn && !isHost) return;
  const die = document.getElementById('pts-die');
  if(!die) return;
  die.classList.add('rolling');
  setTimeout(async()=>{
    die.classList.remove('rolling');
    const roll = d6();
    die.textContent = DIE[roll];

    const state = (await roomRef.child('gameState').once('value')).val();
    const curAnimal = state.currentAnimal;
    const hex = encodeAnimal(curAnimal);
    const newScore = (state.scores[hex]||0) + roll;
    await roomRef.child('gameState/scores/'+hex).set(newScore);
    localScores[curAnimal] = newScore;

    setTimeout(async()=>{
      if(newScore >= localTargetPts){
        await hostEndGame();
        return;
      }
      // Show result inline
      const area = document.getElementById('slide-area');
      if(area.querySelector('.pts-card')){
        area.querySelector('.pts-card').innerHTML=`
          <div class="pts-result">+${roll} POINTS!</div>
          <div class="pts-big">${roll}</div>
          <div class="pts-roll-label">${curAnimal} now has ${newScore} pts</div>
          <button class="next-btn" onclick="hostNextPlayer()">Next Player â†’</button>`;
      }
      renderScoreBar();
    }, 300);
  }, 480);
}

function hostRollSteal(){
  if(!isMyTurn && !isHost) return;
  const die = document.getElementById('steal-die');
  if(!die) return;
  die.classList.add('rolling');
  setTimeout(async()=>{
    die.classList.remove('rolling');
    const roll = d6();
    die.textContent = DIE[roll];

    const state = (await roomRef.child('gameState').once('value')).val();
    const curAnimal = state.currentAnimal;
    const victim = state.stealVictim;
    const curHex = encodeAnimal(curAnimal);
    const vicHex = encodeAnimal(victim);

    const newCurScore = (state.scores[curHex]||0) + roll;
    const newVicScore = (state.scores[vicHex]||0) - roll;

    await roomRef.child('gameState').update({
      phase: 'steal_result',
      stealAmt: roll,
      ['scores/'+curHex]: newCurScore,
      ['scores/'+vicHex]: newVicScore,
    });

    localScores[curAnimal] = newCurScore;
    localScores[victim] = newVicScore;
    renderScoreBar();

    if(newCurScore >= localTargetPts){ setTimeout(hostEndGame, 1200); }
  }, 480);
}

async function hostNextPlayer(){
  const state = (await roomRef.child('gameState').once('value')).val();
  const animals = state.animalList || localPlayers;
  const curIdx = animals.indexOf(state.currentAnimal);
  const nextIdx = (curIdx+1) % animals.length;
  const nextAnimal = animals[nextIdx];
  const newRound = nextIdx===0 ? (state.round||1)+1 : (state.round||1);
  await roomRef.child('gameState').update({ phase:'roll', currentAnimal:nextAnimal, round:newRound, currentCard:null, stealVictim:null, stealAmt:null });
}

async function hostEndGame(){
  await roomRef.child('gameState').update({ phase:'win' });
}

function showWinScreen(state){
  const animals = state.animalList || localPlayers;
  const scores = {};
  if(state.scores) Object.entries(state.scores).forEach(([hex,pts])=>{ scores[decodeAnimal(hex)]=pts; });
  const sorted = animals.map(a=>({a, pts:scores[a]||0})).sort((a,b)=>b.pts-a.pts);
  const winner = sorted[0];
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£'];

  const set=(id,val,prop='textContent')=>{ const el=document.getElementById(id); if(el) el[prop]=val; };
  set('win-name', winner.a);
  set('win-score', winner.pts+' POINTS');
  set('win-jp', winner.a+'ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼');
  set('final-list', sorted.map((p,i)=>`<div class="fl-row${i===0?' top':''}"><span>${medals[i]||''}</span><span style="font-size:1.3rem">${p.a}</span><span style="flex:1"></span><span class="fl-pts">${p.pts} pts</span></div>`).join(''), 'innerHTML');
  showScreen('win');
}

function renderScoreBar(){
  const cur = localPlayers[localCurrentIdx] || localPlayers[0];
  document.getElementById('score-bar').innerHTML = localPlayers.map(a=>`
    <div class="sc${a===cur?' active':''}${a===myAnimal?' me':''}">
      <div class="sa">${a}</div>
      <div class="sp">${localScores[a]||0}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function proceedToFeedback(){
  fbStar=0; fbDiff=''; fbSlots=new Set(); fbSubmitted=false;
  document.getElementById('fb-animal').textContent = myAnimal && myAnimal!=='ğŸ‘¨â€ğŸ«' ? myAnimal : 'ğŸ“';
  document.querySelectorAll('.star-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
  document.querySelectorAll('.check-btn').forEach(b=>b.classList.remove('selected'));
  const btn=document.getElementById('fb-submit'); if(btn){btn.disabled=true;btn.classList.remove('ready');}
  document.getElementById('fb-submitted-msg').style.display='none';
  showScreen('feedback');
}

function setStar(n){
  fbStar=n;
  document.querySelectorAll('.star-btn').forEach((b,i)=>b.classList.toggle('active',i<n));
  checkFbReady();
}
function setDiff(val){
  fbDiff=val;
  const map={'too_easy':0,'just_right':1,'too_hard':2};
  document.querySelectorAll('.choice-btn').forEach((b,i)=>b.classList.toggle('selected',i===map[val]));
  checkFbReady();
}
function toggleSlot(s){
  if(fbSlots.has(s)) fbSlots.delete(s); else fbSlots.add(s);
  document.querySelectorAll('.check-btn').forEach(b=>{
    b.classList.toggle('selected', fbSlots.has(b.textContent.includes('Visual')?'Slot 1 - Visual':b.textContent.includes('Translation')?'Slot 2 - Translation':b.textContent.includes('Spelling')?'Slot 3 - Spelling':b.textContent.includes('Sentence')?'Slot 4 - Sentence':'Slot 5 - Synthesis'));
  });
  // simpler approach
  document.querySelectorAll('.check-btn').forEach(b=>{ b.classList.toggle('selected', [...fbSlots].some(s=>b.onclick.toString().includes(s.replace(' - ','')))); });
}
function checkFbReady(){
  const ready=fbStar>0&&fbDiff!=='';
  const btn=document.getElementById('fb-submit');
  if(btn){btn.disabled=!ready;btn.classList.toggle('ready',ready);}
}

async function submitFeedback(){
  if(!fbStar||!fbDiff||fbSubmitted) return;
  fbSubmitted = true;

  const animalId = myAnimal && myAnimal!=='ğŸ‘¨â€ğŸ«' ? encodeAnimal(myAnimal) : 'teacher_'+Date.now();
  const entry = {
    animal: myAnimal || 'anonymous',
    funScore: fbStar,
    difficulty: fbDiff,
    hardSlots: [...fbSlots],
    sessionId: sessionId || roomId || 'unknown',
    timestamp: Date.now(),
    date: new Date().toISOString().split('T')[0]
  };

  try {
    // Store in room feedback
    if(roomRef) await roomRef.child('feedback/'+animalId).set(entry);
    // Store in global feedback collection
    await db.ref('feedback/'+sessionId+'_'+animalId).set(entry);
  } catch(e){ console.error('Feedback error:', e); }

  // Show done
  const btn = document.getElementById('fb-submit');
  if(btn) btn.style.display='none';
  document.getElementById('fb-submitted-msg').style.display='flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let logoTapCount=0, logoTapTimer=null;
function logoTap(){
  logoTapCount++;
  if(logoTapTimer) clearTimeout(logoTapTimer);
  logoTapTimer=setTimeout(()=>logoTapCount=0,1500);
  if(logoTapCount>=5){ logoTapCount=0; showDashboard(); }
}

function showDashboard(){
  showScreen('dashboard');
  document.getElementById('db-grid').innerHTML='<div class="db-loading">Loading feedback data...</div>';
  db.ref('feedback').once('value').then(snap=>{
    const raw = snap.val();
    if(!raw){ document.getElementById('db-grid').innerHTML='<div class="db-empty">No feedback yet.<br>Play some games first!</div>'; return; }
    renderDashboard(Object.values(raw));
  }).catch(()=>{
    document.getElementById('db-grid').innerHTML='<div class="db-empty">Could not load data. Check connection.</div>';
  });
}

function renderDashboard(all){
  const n=all.length;
  if(n===0){ document.getElementById('db-grid').innerHTML='<div class="db-empty">No feedback yet.</div>'; return; }

  const avgFun=(all.reduce((s,e)=>s+(e.funScore||0),0)/n).toFixed(1);
  const funPct=((avgFun/5)*100).toFixed(0);

  const diffCount={too_easy:0,just_right:0,too_hard:0};
  all.forEach(e=>{ if(diffCount[e.difficulty]!==undefined) diffCount[e.difficulty]++; });

  const slotCount={'Slot 1 - Visual':0,'Slot 2 - Translation':0,'Slot 3 - Spelling':0,'Slot 4 - Sentence':0,'Slot 5 - Synthesis':0};
  all.forEach(e=>{ (e.hardSlots||[]).forEach(s=>{ if(slotCount[s]!==undefined) slotCount[s]++; }); });
  const maxSlot=Math.max(...Object.values(slotCount),1);

  const lastDate=all.reduce((l,e)=>e.timestamp>l?e.timestamp:l,0);
  const lastDateStr=lastDate?new Date(lastDate).toLocaleDateString('en-GB'):'â€”';

  const diffBar=(label,key,color)=>{
    const cnt=diffCount[key]||0;
    const pct=Math.round((cnt/n)*100);
    return `<div class="db-bar-row"><div class="db-bar-lbl">${label}</div><div class="db-bar-track"><div class="db-bar-fill" style="width:${pct}%;background:${color}"><span class="db-bar-val">${cnt}</span></div></div></div>`;
  };

  const slotColors={'Slot 1 - Visual':'#2980b9','Slot 2 - Translation':'#27ae60','Slot 3 - Spelling':'#c9980a','Slot 4 - Sentence':'#e67e22','Slot 5 - Synthesis':'#e74c3c'};
  const slotBar=s=>{
    const cnt=slotCount[s]||0;
    const pct=Math.round((cnt/maxSlot)*100);
    return `<div class="db-bar-row"><div class="db-bar-lbl">${s}</div><div class="db-bar-track"><div class="db-bar-fill" style="width:${pct}%;background:${slotColors[s]}"><span class="db-bar-val">${cnt}</span></div></div></div>`;
  };

  document.getElementById('db-grid').innerHTML=`
    <div class="db-card">
      <div class="db-card-title">OVERVIEW</div>
      <div class="db-stat-row">
        <div class="db-stat"><div class="db-stat-val">${n}</div><div class="db-stat-lbl">Total Responses</div></div>
        <div class="db-stat"><div class="db-stat-val">${avgFun}</div><div class="db-stat-lbl">Avg Fun Score<br>(out of 5)</div></div>
        <div class="db-stat"><div class="db-stat-val">${diffCount.just_right}</div><div class="db-stat-lbl">Said Just Right</div></div>
      </div>
      <div class="db-responses">Last response: ${lastDateStr}</div>
    </div>
    <div class="db-card">
      <div class="db-card-title">FUN SCORE</div>
      <div class="db-big">${avgFun}<span style="font-size:1.2rem;opacity:.4"> / 5</span></div>
      <div class="fun-track"><div class="fun-fill" style="width:${funPct}%"></div></div>
      <div class="fun-labels"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
    </div>
    <div class="db-card">
      <div class="db-card-title">DIFFICULTY</div>
      ${diffBar('Too Easy','too_easy','#3498db')}
      ${diffBar('Just Right','just_right','#27ae60')}
      ${diffBar('Too Hard','too_hard','#e74c3c')}
    </div>
    <div class="db-card">
      <div class="db-card-title">HARDEST SLOTS</div>
      ${Object.keys(slotCount).map(slotBar).join('')}
      <div style="font-size:.65rem;color:rgba(240,235,224,.25);margin-top:6px;font-family:'DM Sans',sans-serif">Students can select multiple</div>
    </div>
    <button class="db-reset" onclick="resetDashboard()">ğŸ—‘ Delete All Feedback Data</button>
  `;
}

function resetDashboard(){
  if(confirm('Delete ALL feedback data from Firebase?\nThis cannot be undone.')){
    db.ref('feedback').remove().then(()=>{
      document.getElementById('db-grid').innerHTML='<div class="db-empty">All data deleted.</div>';
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE / CLEANUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function leaveRoom(){
  if(gameListener && roomRef) roomRef.child('gameState').off('value', gameListener);
  if(lobbyListener && roomRef) roomRef.child('players').off('value', lobbyListener);
  if(roomRef) roomRef.child('gameState/phase').off();
  if(!isHost && roomRef && myAnimal){
    roomRef.child('players/'+encodeAnimal(myAnimal)).remove();
  }
  roomId=null; roomRef=null; isHost=false; myAnimal=null; localPlayers=[];
  showHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initVoice();
renderInstrSlide();
</script>
</body>
</html>
